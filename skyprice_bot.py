# @Author: Humberto Alejandro Ortega Alcocer
# @Date: 2024-Abril-8
# @Description: Bot de Telegram para la valuaci√≥n de departamentos en la Ciudad de M√©xico utilizando OpenAI y la API de SkyPrice.
# @Dependencies: python-telegram-bot, openai, requests
# @Usage: python skyprice_bot.py
# @License: MIT
import logging
from typing import Union
from telegram import  Update
from telegram.ext import (
    Application,
    CommandHandler,
    ContextTypes,
    ConversationHandler,
    MessageHandler,
    filters,
)
import requests
from openai import OpenAI
import json
from dotenv import load_dotenv
import os

# Load environment variables
load_dotenv()

# Initialize OpenAI API key
client = OpenAI(api_key=os.getenv('OPENAI_API_KEY'))

# SkyPrice API URL
SKYPRICE_API_URL = 'https://api.skyprice.xyz/predict'

# Telegram bot token
TELEGRAM_TOKEN = os.getenv('TELEGRAM_TOKEN','fake_token')

# Language dictionary
LANGUAGE_COMMANDS = {
    'inicio': 'es',
    'start': 'es', # Spanish by default
    'english': 'en',
    'french': 'fr',
    'portuguese': 'pt'
}

# Enable logging
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO
)
# Set higher logging level for httpx to avoid all GET and POST requests being logged
logging.getLogger("httpx").setLevel(logging.WARNING)

# Get the logger instance
logger = logging.getLogger(__name__)

# Clase para representar los datos requeridos de un departamento
class ApartmentDetails:
    def __init__(self, size_terrain, size_construction, rooms, bathrooms, parking, age, lat, lng, municipality):
        """Initialize the apartment details."""
        self.Size_Terrain = size_terrain
        self.Size_Construction = size_construction
        self.Rooms = rooms
        self.Bathrooms = bathrooms
        self.Parking = parking
        self.Age = age
        self.Lat = lat
        self.Lng = lng
        self.Municipality = municipality

# Clase para representar la predicci√≥n de precios
class PricePrediction:
    def __init__(self, random_forest, svm, neural_network):
        """Initialize the price prediction."""
        self.Random_Forest = random_forest
        self.SVM = svm
        self.Neural_Network = neural_network

async def set_language(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Set the language for the bot."""
    command = update.message.text.lower().strip('/')
    if command in LANGUAGE_COMMANDS:
        context.user_data['language'] = LANGUAGE_COMMANDS[command]
    language = context.user_data.get('language', 'es')

    user = update.message.from_user
    logger.info(f"Language set to {language} for {user.first_name}")

    if language == 'es':
        await start(update, context)
    elif language == 'en':
        await start_en(update, context)
    elif language == 'fr':
        await start_fr(update, context)
    elif language == 'pt':
        await start_pt(update, context)

    return ConversationHandler.END

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Send a message when the command /inicio is issued."""
    # Log the start command user and message
    user = update.message.from_user
    logger.info("Comando de inicio recibido de %s: %s", user.first_name, update.message.text)

    # Send the welcome message
    await update.message.reply_text(
        'üè° ¬°Hola! Soy el bot de SkyPrice. Env√≠ame un mensaje con los detalles del departamento en la Ciudad de M√©xico y te dir√© el precio estimado. Los detalles deben incluir:\n\n'
        'üìè Tama√±o del terreno\n'
        'üèóÔ∏è Tama√±o de la construcci√≥n\n'
        'üõèÔ∏è N√∫mero de habitaciones\n'
        'üöΩ N√∫mero de ba√±os\n'
        'üöó N√∫mero de estacionamientos\n'
        'üï∞Ô∏è Antig√ºedad\n'
        'üåç Alcald√≠a\n\n'
        'El bot utilizar√° OpenAI para extraer los detalles del texto y la API de SkyPrice para predecir el precio. ¬°Int√©ntalo ahora! üöÄ\n\n'
        'Ejemplo: "el departamento tiene 100 m¬≤ de terreno, 80 m¬≤ de construcci√≥n, 2 habitaciones, 1 ba√±o, 1 estacionamiento, 10 a√±os de antig√ºedad y est√° en la alcald√≠a Benito Ju√°rez".\n\n'
        'For English instructions, type /english.\n'
        'Pour des instructions en fran√ßais, tapez /french.\n'
        'Para instru√ß√µes em portugu√™s, digite /portuguese.\n'
    )

    return ConversationHandler.END

async def start_fr(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Send a message when the command /french is issued."""
    # Log the start command user and message
    user = update.message.from_user
    logger.info("Comando de inicio en franc√©s recibido de %s: %s", user.first_name, update.message.text)

    # Send the welcome message
    await update.message.reply_text(
        'üè° Bonjour! Je suis le bot SkyPrice. Envoyez-moi un message avec les d√©tails de l\'appartement √† Mexico et je vous dirai le prix estim√©. Les d√©tails doivent inclure:\n\n'
        'üìè Taille du terrain\n'
        'üèóÔ∏è Taille de la construction\n'
        'üõèÔ∏è Nombre de chambres\n'
        'üöΩ Nombre de salles de bains\n'
        'üöó Nombre de places de parking\n'
        'üï∞Ô∏è √Çge\n'
        'üåç Municipalit√©\n\n'
        'Le bot utilisera OpenAI pour extraire les d√©tails du texte et l\'API SkyPrice pour pr√©dire le prix. Essayez maintenant! üöÄ\n\n'
        'Exemple: "l\'appartement a 100 m¬≤ de terrain, 80 m¬≤ de construction, 2 chambres, 1 salle de bain, 1 place de parking, 10 ans et est dans la municipalit√© de Benito Ju√°rez".\n\n'
        'Para instrucciones en espa√±ol, escriba /inicio.\n'
        'For English instructions, type /english.\n'
        'Para instru√ß√µes em portugu√™s, digite /portuguese.\n'
    )

    return ConversationHandler.END

async def start_pt(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Send a message when the command /portuguese is issued."""
    # Log the start command user and message
    user = update.message.from_user
    logger.info("Comando de inicio en portugu√©s recibido de %s: %s", user.first_name, update.message.text)

    # Send the welcome message
    await update.message.reply_text(
        'üè° Ol√°! Eu sou o bot SkyPrice. Envie-me uma mensagem com os detalhes do apartamento na Cidade do M√©xico e eu direi o pre√ßo estimado. Os detalhes devem incluir:\n\n'
        'üìè Tamanho do terreno\n'
        'üèóÔ∏è Tamanho da constru√ß√£o\n'
        'üõèÔ∏è N√∫mero de quartos\n'
        'üöΩ N√∫mero de banheiros\n'
        'üöó N√∫mero de vagas de estacionamento\n'
        'üï∞Ô∏è Idade\n'
        'üåç Munic√≠pio\n\n'
        'O bot usar√° o OpenAI para extrair os detalhes do texto e a API SkyPrice para prever o pre√ßo. Experimente agora! üöÄ\n\n'
        'Exemplo: "o apartamento tem 100 m¬≤ de terreno, 80 m¬≤ de constru√ß√£o, 2 quartos, 1 banheiro, 1 vaga de estacionamento, 10 anos de idade e est√° na municipalidade de Benito Ju√°rez".\n\n'
        'Para instrucciones en espa√±ol, escriba /inicio.\n'
        'Pour des instructions en fran√ßais, tapez /french.\n'
        'For English instructions, type /english.\n'
    )

    return ConversationHandler.END

async def start_en(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Send a message when the command /english is issued."""
    # Log the start command user and message
    user = update.message.from_user
    logger.info("Comando de inicio en ingl√©s recibido de %s: %s", user.first_name, update.message.text)

    # Send the welcome message
    await update.message.reply_text(
        'üè° Hello! I am the SkyPrice bot. Send me a message with the details of the apartment in Mexico City and I will tell you the estimated price. The details must include:\n\n'
        'üìè Terrain size\n'
        'üèóÔ∏è Construction size\n'
        'üõèÔ∏è Number of rooms\n'
        'üöΩ Number of bathrooms\n'
        'üöó Number of parking spaces\n'
        'üï∞Ô∏è Age\n'
        'üåç Municipality\n\n'
        'The bot will use OpenAI to extract the details from the text and the SkyPrice API to predict the price. Try it now! üöÄ\n\n'
        'Example: "the apartment has 100 m¬≤ of terrain, 80 m¬≤ of construction, 2 rooms, 1 bathroom, 1 parking space, 10 years old and is in the Benito Ju√°rez municipality".\n\n'
        'Para instrucciones en espa√±ol, escriba /inicio.\n'
        'Pour des instructions en fran√ßais, tapez /french.\n'
        'Para instru√ß√µes em portugu√™s, digite /portuguese.\n'
    )

    return ConversationHandler.END

def extract_apartment_details(text) -> Union[ApartmentDetails, None]:
    """Extract apartment details from the text using OpenAI's GPT-3."""

    # Log the text to extract apartment details
    logger.info(f"Extracting apartment details from text: {text}")

    # Use OpenAI's GPT-3 to extract apartment details
    try:
        response = client.chat.completions.create(
            model="gpt-4o",
            messages=[
                {
                    "role": "system",
                    "content": [
                        {
                            "type": "text",
                            "text": "Extract the following CDMX apartment details from the text in JSON format, if impossible to extract, leave null: \n{\"Size_Terrain\":int,\"Size_Construction\":int,\"Rooms\":int,\"Bathrooms\":float,Parking\":int,\"Age\":int,\"Lat\":float, \"Lng\":float,\"Municipality\":str} \nUnits should be in meters for size and years for age. If given the date of construction, calculate age. \nLat and Lng you should provide with the closer coordinates you can find for the apartment \nor fallback to the center of detected Municipality (always provide lat/lng). \nMunicipality should be one of the 16 CDMX municipalities: [\n√Ålvaro Obreg√≥n', 'Azcapotzalco', 'Benito Ju√°rez', 'Coyoac√°n', 'Cuajimalpa', 'Cuauht√©moc',\nGustavo A. Madero', 'Iztacalco', 'Iztapalapa', 'Magdalena Contreras', 'Miguel Hidalgo',\nMilpa Alta', 'Tl√°huac', 'Tlalpan', 'Venustiano Carranza', 'Xochimilco']\nProvide the response without any formatting or additional line breaks, just the minified JSON ready to serialize.\n"
                        }
                    ]
                },
                {
                    "role": "user",
                    "content": [
                        {
                            "type": "text",
                            "text": text
                        }
                    ]
                }
            ],
            temperature=0.5,
            max_tokens=600,
            top_p=1,
            frequency_penalty=0,
            presence_penalty=0
        )

        # Log the response from OpenAI
        logger.info(f"Apartment details response: {response.__dict__}")

        # Cast the response to a dictionary
        details_json = response.choices[0].message.content
        details_dict = json.loads(details_json)

        # Log the apartment details dictionary
        logger.info(f"Apartment details dictionary: {details_dict}")

        # Return the apartment details
        return ApartmentDetails(
            size_terrain=details_dict['Size_Terrain'],
            size_construction=details_dict['Size_Construction'],
            rooms=details_dict['Rooms'],
            bathrooms=details_dict['Bathrooms'],
            parking=details_dict['Parking'],
            age=details_dict['Age'],
            lat=details_dict['Lat'],
            lng=details_dict['Lng'],
            municipality=details_dict['Municipality']
        )
    except Exception as e:
        # Log the error extracting apartment details
        logger.info(f"Error extracting apartment details: {e}")
        return None

def predict_price(details: ApartmentDetails) -> PricePrediction:
    """Predict the price of the apartment using the SkyPrice API."""
    response = requests.post(SKYPRICE_API_URL, json=details.__dict__)
    response_json = response.json()
    logger.info(f"Price prediction response: {response_json}")
    return PricePrediction(
        random_forest=response_json['random_forest'],
        svm=response_json['svm'],
        neural_network=response_json['neural_network']
    )

def format_price(price: str) -> str:
    """Format the price to follow $123,456.78 MXN format."""
    return f"${float(price):,.2f} MXN"

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Handle the message from the user."""
    user = update.message.from_user
    logger.info("Valuaci√≥n de departamento recibida de %s: %s", user.first_name, update.message.text)

    # Obtener el idioma del usuario
    language = context.user_data.get('language', 'es')

    if language == 'es':
        await update.message.reply_text(
            "üè° SkyPrice ChatBot ü§ñ\n\n"
            "üìù ¬°Gracias! Mensaje recibido. üì©\n\n"
            "üîÑ Procesando tu solicitud..."
        )
    elif language == 'en':
        await update.message.reply_text(
            "üè° SkyPrice ChatBot ü§ñ\n\n"
            "üìù Thank you! Message received. üì©\n\n"
            "üîÑ Processing your request..."
        )
    elif language == 'fr':
        await update.message.reply_text(
            "üè° SkyPrice ChatBot ü§ñ\n\n"
            "üìù Merci! Message re√ßu. üì©\n\n"
            "üîÑ Traitement de votre demande..."
        )
    elif language == 'pt':
        await update.message.reply_text(
            "üè° SkyPrice ChatBot ü§ñ\n\n"
            "üìù Obrigado! Mensagem recebida. üì©\n\n"
            "üîÑ Processando sua solicita√ß√£o..."
        )

    try:
        # Extrae los detalles del departamento del mensaje del usuario
        user_text = update.message.text
        details_text= extract_apartment_details(user_text)

        # Valida si se pudieron extraer los detalles del departamento
        if not details_text:
            logger.info("No se pudieron extraer los detalles del departamento del mensaje del usuario %s: %s", user.first_name, user_text)

            if language == 'es':
                await update.message.reply_text('‚ùå Lo siento, no pude extraer los detalles del departamento de tu mensaje. Por favor, int√©ntalo de nuevo. Si necesitas ayuda, escribe /inicio.')
            elif language == 'en':
                await update.message.reply_text('‚ùå Sorry, I could not extract the apartment details from your message. Please try again. If you need help, type /english.')
            elif language == 'fr':
                await update.message.reply_text('‚ùå D√©sol√©, je n\'ai pas pu extraire les d√©tails de l\'appartement de votre message. Veuillez r√©essayer. Si vous avez besoin d\'aide, tapez /french.')
            elif language == 'pt':
                await update.message.reply_text('‚ùå Desculpe, n√£o consegui extrair os detalhes do apartamento da sua mensagem. Por favor, tente novamente. Se precisar de ajuda, digite /portuguese.')

            return ConversationHandler.END

        # Convierte los detalles del departamento a un diccionario
        details_dict = details_text.__dict__

        # Validate that all required keys are present and not None, if not, provide the user with feedback on missing keys.
        required_keys = ['Size_Terrain', 'Size_Construction', 'Rooms', 'Bathrooms', 'Parking', 'Age', 'Lat', 'Lng', 'Municipality']
        missing_keys = [key for key in required_keys if key not in details_dict or details_dict[key] is None]
        if missing_keys:
            logger.info("Missing keys: %s", missing_keys)
            required_keys_es = {'Size_Terrain': 'Tama√±o del terreno', 'Size_Construction': 'Tama√±o de la construcci√≥n', 'Rooms': 'Habitaciones', 'Bathrooms': 'Ba√±os', 'Parking': 'Estacionamientos', 'Age': 'Antig√ºedad', 'Lat': 'Latitud', 'Lng': 'Longitud', 'Municipality': 'Alcald√≠a'}
            required_keys_fr = {'Size_Terrain': 'Taille du terrain', 'Size_Construction': 'Taille de la construction', 'Rooms': 'Chambres', 'Bathrooms': 'Salles de bains', 'Parking': 'Places de parking', 'Age': '√Çge', 'Lat': 'Latitude', 'Lng': 'Longitude', 'Municipality': 'Municipalit√©'}
            required_keys_pt = {'Size_Terrain': 'Tamanho do terreno', 'Size_Construction': 'Tamanho da constru√ß√£o', 'Rooms': 'Quartos', 'Bathrooms': 'Banheiros', 'Parking': 'Vagas de estacionamento', 'Age': 'Idade', 'Lat': 'Latitude', 'Lng': 'Longitude', 'Municipality': 'Munic√≠pio'}
            if language == 'es':
                missing_keys = [required_keys_es[key] for key in missing_keys]
            elif language == 'fr':
                missing_keys = [required_keys_fr[key] for key in missing_keys]
            elif language == 'pt':
                missing_keys = [required_keys_pt[key] for key in missing_keys]

            if language == 'es':
                await update.message.reply_text(f'‚ùå Lo siento, no pude extraer los siguientes detalles del departamento de tu mensaje: {", ".join(missing_keys)}. Por favor, int√©ntalo de nuevo. Si necesitas ayuda, escribe /inicio.')
            elif language == 'en':
                await update.message.reply_text(f'‚ùå Sorry, I could not extract the following apartment details from your message: {", ".join(missing_keys)}. Please try again. If you need help, type /english.')
            elif language == 'fr':
                await update.message.reply_text(f'‚ùå D√©sol√©, je n\'ai pas pu extraire les d√©tails de l\'appartement suivants de votre message: {", ".join(missing_keys)}. Veuillez r√©essayer. Si vous avez besoin d\'aide, tapez /french.')
            elif language == 'pt':
                await update.message.reply_text(f'‚ùå Desculpe, n√£o consegui extrair os seguintes detalhes do apartamento da sua mensagem: {", ".join(missing_keys)}. Por favor, tente novamente. Se precisar de ajuda, digite /portuguese.')

            return ConversationHandler.END

        # Validate that municipality is valid, if not, provide the user with feedback on invalid municipality.
        valid_municipalities = ['√Ålvaro Obreg√≥n', 'Azcapotzalco', 'Benito Ju√°rez', 'Coyoac√°n', 'Cuajimalpa de Morelos', 'Cuauht√©moc',
                  'Gustavo A. Madero', 'Iztacalco', 'Iztapalapa', 'Magdalena Contreras', 'Miguel Hidalgo',
                  'Milpa Alta', 'Tl√°huac', 'Tlalpan', 'Venustiano Carranza', 'Xochimilco']
        if details_dict['Municipality'] not in valid_municipalities:
            logger.info("Municipality is invalid")

            if language == 'es':
                await update.message.reply_text(f'‚ùå Lo siento, la alcald√≠a proporcionada ({details_dict["Municipality"]}) no es v√°lida. Por favor, int√©ntalo de nuevo. Si necesitas ayuda, escribe /inicio.')
            elif language == 'en':
                await update.message.reply_text(f'‚ùå Sorry, the provided municipality ({details_dict["Municipality"]}) is invalid. Please try again. If you need help, type /english.')
            elif language == 'fr':
                await update.message.reply_text(f'‚ùå D√©sol√©, la municipalit√© fournie ({details_dict["Municipality"]}) est invalide. Veuillez r√©essayer. Si vous avez besoin d\'aide, tapez /french.')
            elif language == 'pt':
                await update.message.reply_text(f'‚ùå Desculpe, a municipalidade fornecida ({details_dict["Municipality"]}) √© inv√°lida. Por favor, tente novamente. Se precisar de ajuda, digite /portuguese.')

            return ConversationHandler.END

        # Validate that numeric values are numeric and positive or zero, if not, provide the user with feedback on offending fields.
        numeric_fields = ['Size_Terrain', 'Size_Construction', 'Rooms', 'Bathrooms', 'Parking', 'Age']
        invalid_fields = [field for field in numeric_fields if not isinstance(details_dict[field], (int, float)) or details_dict[field] < 0]
        if invalid_fields:
            logger.info("Invalid fields: %s", invalid_fields)
            invalid_fields_es = {'Size_Terrain': 'Tama√±o del terreno', 'Size_Construction': 'Tama√±o de la construcci√≥n', 'Rooms': 'Habitaciones', 'Bathrooms': 'Ba√±os', 'Parking': 'Estacionamientos', 'Age': 'Antig√ºedad'}
            invalid_fields_en = {'Size_Terrain': 'Terrain size', 'Size_Construction': 'Construction size', 'Rooms': 'Rooms', 'Bathrooms': 'Bathrooms', 'Parking': 'Parking spaces', 'Age': 'Age'}
            invalid_fields_fr = {'Size_Terrain': 'Taille du terrain', 'Size_Construction': 'Taille de la construction', 'Rooms': 'Chambres', 'Bathrooms': 'Salles de bains', 'Parking': 'Places de parking', 'Age': '√Çge'}
            invalid_fields_pt = {'Size_Terrain': 'Tamanho do terreno', 'Size_Construction': 'Tamanho da constru√ß√£o', 'Rooms': 'Quartos', 'Bathrooms': 'Banheiros', 'Parking': 'Vagas de estacionamento', 'Age': 'Idade'}
            if language == 'es':
                invalid_fields = [invalid_fields_es[field] for field in invalid_fields]
            elif language == 'en':
                invalid_fields = [invalid_fields_en[field] for field in invalid_fields]
            elif language == 'fr':
                invalid_fields = [invalid_fields_fr[field] for field in invalid_fields]
            elif language == 'pt':
                invalid_fields = [invalid_fields_pt[field] for field in invalid_fields]

            invalid_fields = [invalid_fields_es[field] for field in invalid_fields]

            if language == 'es':
                await update.message.reply_text(f'‚ùå Lo siento, los siguientes campos num√©ricos no son v√°lidos: {", ".join(invalid_fields)}. Por favor, int√©ntalo de nuevo. Si necesitas ayuda, escribe /inicio.')
            elif language == 'en':
                await update.message.reply_text(f'‚ùå Sorry, the following numeric fields are not valid: {", ".join(invalid_fields)}. Please try again. If you need help, type /english.')
            elif language == 'fr':
                await update.message.reply_text(f'‚ùå D√©sol√©, les champs num√©riques suivants ne sont pas valides: {", ".join(invalid_fields)}. Veuillez r√©essayer. Si vous avez besoin d\'aide, tapez /french.')
            elif language == 'pt':
                await update.message.reply_text(f'‚ùå Desculpe, os seguintes campos num√©ricos n√£o s√£o v√°lidos: {", ".join(invalid_fields)}. Por favor, tente novamente. Se precisar de ajuda, digite /portuguese.')

            return ConversationHandler.END


        # Validate that numeric values are within the expected range, if not, provide the user with feedback on offending fields.
        size_limits = {'Size_Terrain': 10000, 'Size_Construction': 10000, 'Rooms': 20, 'Bathrooms': 20, 'Parking': 20, 'Age': 100}
        invalid_fields = [field for field in numeric_fields if details_dict[field] > size_limits[field]]
        if invalid_fields:
            logger.info("Invalid fields: %s", invalid_fields)
            invalid_fields_es = {'Size_Terrain': 'Tama√±o del terreno', 'Size_Construction': 'Tama√±o de la construcci√≥n', 'Rooms': 'Habitaciones', 'Bathrooms': 'Ba√±os', 'Parking': 'Estacionamientos', 'Age': 'Antig√ºedad'}
            invalid_fields_en = {'Size_Terrain': 'Terrain size', 'Size_Construction': 'Construction size', 'Rooms': 'Rooms', 'Bathrooms': 'Bathrooms', 'Parking': 'Parking spaces', 'Age': 'Age'}
            invalid_fields_fr = {'Size_Terrain': 'Taille du terrain', 'Size_Construction': 'Taille de la construction', 'Rooms': 'Chambres', 'Bathrooms': 'Salles de bains', 'Parking': 'Places de parking', 'Age': '√Çge'}
            invalid_fields_pt = {'Size_Terrain': 'Tamanho do terreno', 'Size_Construction': 'Tamanho da constru√ß√£o', 'Rooms': 'Quartos', 'Bathrooms': 'Banheiros', 'Parking': 'Vagas de estacionamento', 'Age': 'Idade'}
            if language == 'es':
                invalid_fields = [invalid_fields_es[field] for field in invalid_fields]
            elif language == 'en':
                invalid_fields = [invalid_fields_en[field] for field in invalid_fields]
            elif language == 'fr':
                invalid_fields = [invalid_fields_fr[field] for field in invalid_fields]
            elif language == 'pt':
                invalid_fields = [invalid_fields_pt[field] for field in invalid_fields]

            if language == 'es':
                await update.message.reply_text(f'‚ùå Lo siento, los siguientes campos num√©ricos exceden los l√≠mites esperados: {", ".join(invalid_fields)}. Por favor, int√©ntalo de nuevo. Si necesitas ayuda, escribe /inicio.')
            elif language == 'en':
                await update.message.reply_text(f'‚ùå Sorry, the following numeric fields exceed the expected limits: {", ".join(invalid_fields)}. Please try again. If you need help, type /english.')
            elif language == 'fr':
                await update.message.reply_text(f'‚ùå D√©sol√©, les champs num√©riques suivants d√©passent les limites attendues: {", ".join(invalid_fields)}. Veuillez r√©essayer. Si vous avez besoin d\'aide, tapez /french.')
            elif language == 'pt':
                await update.message.reply_text(f'‚ùå Desculpe, os seguintes campos num√©ricos excedem os limites esperados: {", ".join(invalid_fields)}. Por favor, tente novamente. Se precisar de ajuda, digite /portuguese.')

            return ConversationHandler.END


        # Env√≠a un mensaje con los detalles del departamento
        if language == 'es':
            await update.message.reply_text(
                f"üè¢ Detalles del departamento extra√≠dos:\n\n"
                f"üìè Tama√±o del terreno: {details_text.Size_Terrain}m¬≤\n"
                f"üèóÔ∏è Tama√±o de la construcci√≥n: {details_text.Size_Construction}m¬≤\n"
                f"üõèÔ∏è N√∫mero de habitaciones: {details_text.Rooms}\n"
                f"üöΩ N√∫mero de ba√±os: {details_text.Bathrooms}\n"
                f"üöó N√∫mero de estacionamientos: {details_text.Parking}\n"
                f"üï∞Ô∏è Antig√ºedad: {details_text.Age} a√±os\n"
                f"üåç Alcald√≠a: {details_text.Municipality}"
            )
        elif language == 'en':
            await update.message.reply_text(
                f"üè¢ Extracted apartment details:\n\n"
                f"üìè Terrain size: {details_text.Size_Terrain}m¬≤\n"
                f"üèóÔ∏è Construction size: {details_text.Size_Construction}m¬≤\n"
                f"üõèÔ∏è Number of rooms: {details_text.Rooms}\n"
                f"üöΩ Number of bathrooms: {details_text.Bathrooms}\n"
                f"üöó Number of parking spaces: {details_text.Parking}\n"
                f"üï∞Ô∏è Age: {details_text.Age} years\n"
                f"üåç Municipality: {details_text.Municipality}"
            )
        elif language == 'fr':
            await update.message.reply_text(
                f"üè¢ D√©tails de l'appartement extraits:\n\n"
                f"üìè Taille du terrain: {details_text.Size_Terrain}m¬≤\n"
                f"üèóÔ∏è Taille de la construction: {details_text.Size_Construction}m¬≤\n"
                f"üõèÔ∏è Nombre de chambres: {details_text.Rooms}\n"
                f"üöΩ Nombre de salles de bains: {details_text.Bathrooms}\n"
                f"üöó Nombre de places de parking: {details_text.Parking}\n"
                f"üï∞Ô∏è √Çge: {details_text.Age} ans\n"
                f"üåç Municipalit√©: {details_text.Municipality}"
            )
        elif language == 'pt':
            await update.message.reply_text(
                f"üè¢ Detalhes do apartamento extra√≠dos:\n\n"
                f"üìè Tamanho do terreno: {details_text.Size_Terrain}m¬≤\n"
                f"üèóÔ∏è Tamanho da constru√ß√£o: {details_text.Size_Construction}m¬≤\n"
                f"üõèÔ∏è N√∫mero de quartos: {details_text.Rooms}\n"
                f"üöΩ N√∫mero de banheiros: {details_text.Bathrooms}\n"
                f"üöó N√∫mero de vagas de estacionamento: {details_text.Parking}\n"
                f"üï∞Ô∏è Idade: {details_text.Age} anos\n"
                f"üåç Munic√≠pio: {details_text.Municipality}"
            )


        logger.info("Detalles del departamento extra√≠dos: Tama√±o del terreno: %s, Tama√±o de la construcci√≥n: %s, Habitaciones: %s, Ba√±os: %s, Estacionamientos: %s, Antig√ºedad: %s, Alcald√≠a: %s", details_text.Size_Terrain, details_text.Size_Construction, details_text.Rooms, details_text.Bathrooms, details_text.Parking, details_text.Age, details_text.Municipality)

        # Env√≠a un mensaje con los precios estimados
        price_prediction = predict_price(details_text)

        response_message = (
            f"üí∞ Precios estimados:\n\n"
            f"üå≥ Random Forest: {format_price(price_prediction.Random_Forest)}\n"
            f"üìà SVM: {format_price(price_prediction.SVM)}\n"
            f"üß† Neural Network: {format_price(price_prediction.Neural_Network)}\n\n"
            "üîç Puedes encontrar m√°s detalles en https://skyprice.xyz üè°"
        )
        if language == 'en':
            response_message = (
                f"üí∞ Estimated prices:\n\n"
                f"üå≥ Random Forest: {format_price(price_prediction.Random_Forest)}\n"
                f"üìà SVM: {format_price(price_prediction.SVM)}\n"
                f"üß† Neural Network: {format_price(price_prediction.Neural_Network)}\n\n"
                "üîç You can find more details at https://skyprice.xyz üè°"
            )
        elif language == 'fr':
            response_message = (
                f"üí∞ Prix estim√©s:\n\n"
                f"üå≥ Random Forest: {format_price(price_prediction.Random_Forest)}\n"
                f"üìà SVM: {format_price(price_prediction.SVM)}\n"
                f"üß† Neural Network: {format_price(price_prediction.Neural_Network)}\n\n"
                "üîç Vous pouvez trouver plus de d√©tails sur https://skyprice.xyz üè°"
            )
        elif language == 'pt':
            response_message = (
                f"üí∞ Pre√ßos estimados:\n\n"
                f"üå≥ Random Forest: {format_price(price_prediction.Random_Forest)}\n"
                f"üìà SVM: {format_price(price_prediction.SVM)}\n"
                f"üß† Neural Network: {format_price(price_prediction.Neural_Network)}\n\n"
                "üîç Voc√™ pode encontrar mais detalhes em https://skyprice.xyz üè°"
            )

        await update.message.reply_text(response_message)
        logger.info("Estimaci√≥n de precios: SVM: %s, Random Forest: %s, Neural Network: %s", price_prediction.SVM, price_prediction.Random_Forest, price_prediction.Neural_Network)
    except Exception as e:
        logger.info(f"Error: {e}")
        if language == 'es':
            await update.message.reply_text('‚ùå Lo siento, ha ocurrido un error. Por favor, int√©ntalo de nuevo. Si necesitas ayuda, escribe /inicio.')
        elif language == 'en':
            await update.message.reply_text('‚ùå Sorry, an error occurred. Please try again. If you need help, type /english.')
        elif language == 'fr':
            await update.message.reply_text('‚ùå D√©sol√©, une erreur s\'est produite. Veuillez r√©essayer. Si vous avez besoin d\'aide, tapez /french.')
        elif language == 'pt':
            await update.message.reply_text('‚ùå Desculpe, ocorreu um erro. Por favor, tente novamente. Se precisar de ajuda, digite /portuguese.')

    return ConversationHandler.END

def main() -> None:
    # Log de inicio
    logger.info("Iniciando el bot de Telegram de SkyPrice...")

    # Inicializa la aplicaci√≥n de Telegram
    application = Application.builder().token(TELEGRAM_TOKEN).build()

    # Handle para las instrucciones en otros idiomas
    for command in LANGUAGE_COMMANDS:
        application.add_handler(CommandHandler(command, set_language))

    # Handle para los mensajes de valuaci√≥n de departamentos
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

    # Inicia el bot de Telegram
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == '__main__':
    main()
